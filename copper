// node
var fs = require('fs')
// npm
var chalk = require('chalk')
var Decimal = require('decimal.js')
var args = require('yargs').argv

// local
var Copper = require('./lib/copper')
var copper = new Copper()

if(args._.length == 1 && args._[0].length == 34) {
  args._.unshift('balance')
}

var cmd = args._.shift() || 'balance'

if(cmd === 'balance') {
  var keys

  if(args._.length > 0) {
    var first = args._.shift()
    keys = [ copper.keyFromAddress(first) ]
  }

  if(args.wallet) {
    console.log('wallet:', args.wallet)
    keys = copper.loadBitcoinWallet(args.wallet)
    console.log('' + chalk.green(keys.length), 'keys read.')
  }

  copper.balances(keys).then(function(balances){
    var rows = []
    for(var idx in keys) {
      rows.push({pub:keys[idx].pub, balance:balances[idx]})
    }
    rows.sort(function(a,b){return a.balance.minus(b.balance).toFixed()})
    var values = rows.filter(function(row){return row.balance > 0})
    values.forEach(function(row){
      console.log(row.pub, row.balance.toString())
    })
    var total = balances.reduce(function(memo, balance){return memo.plus(balance)}, new Decimal(0))
    console.log('Wallet Total:', chalk.green(total))
  })
}
